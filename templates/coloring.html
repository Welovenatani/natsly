<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Natsly Coloring</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6a5acd;
      --secondary: #9370db;
      --accent: #5d8aa8;
      --light-bg: #f8f9fa;
      --text: #333;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light-bg);
      color: var(--text);
      overflow: hidden;
      height: 100vh;
      background-image: radial-gradient(#e2d1f9 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    .coloring-app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(106, 90, 205, 0.95);
      color: white;
      position: relative;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    }
    
    .back-btn, .save-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      font-size: 1.2rem;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .back-btn:hover, .save-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .model-info {
      text-align: center;
      flex-grow: 1;
    }
    
    .model-name {
      font-size: 1.2rem;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .canvas-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f7;
    }
    
    #canvas {
      width: 100%;
      height: 100%;
      display: block;
      transition: filter 0.2s ease-out;
      touch-action: none;
      max-width: 100%;
      max-height: 100%;
    }
    
    .tools-panel, .colors-panel {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 50px;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
      transition: opacity 0.5s ease;
      z-index: 100;
      display: flex;
      gap: 15px;
    }
    
    .tools-panel { 
      bottom: 25px;
    }
    
    .colors-panel { 
      bottom: 100px;
      overflow-x: auto;
      max-width: 90vw;
      white-space: nowrap;
      scrollbar-width: none;
      padding: 15px;
    }
    
    .colors-panel::-webkit-scrollbar {
      display: none;
    }
    
    .tool-btn {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--primary);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    
    .tool-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 0 0 3px white, 0 0 0 5px var(--primary);
    }
    
    .tool-btn:active {
      transform: scale(0.9);
    }
    
    .color-swatch {
      min-width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid transparent;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      position: relative;
      display: inline-block;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 0 5px;
    }
    
    .color-swatch.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px white, 0 0 0 6px var(--primary);
    }
    
    .color-swatch:active {
      transform: scale(0.9);
    }
    
    #custom-color {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 50%;
      background: none;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }
    
    .custom-color-wrapper {
      position: relative;
      width: 50px;
      height: 50px;
      display: inline-block;
      margin: 0 5px;
    }
    
    .audio-control {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 100;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      transition: all 0.3s;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    
    .audio-control:hover {
      transform: scale(1.1);
      background: rgba(255,255,255,0.9);
    }
    
    .fill-effect {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
      pointer-events: none;
      width: 150px;
      height: 150px;
      animation: fillGlow 0.3s ease-out both;
    }
    
    @keyframes fillGlow {
      0% { opacity: 0.5; transform: scale(0.5); }
      100% { opacity: 0; transform: scale(2); }
    }
    
    .animated-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fad0c4, #a1c4fd);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      opacity: 0.05;
      pointer-events: none;
      z-index: 0;
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .floating-leaves {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .leaf {
      position: absolute;
      font-size: 1.8rem;
      opacity: 0.7;
      animation: float 15s infinite linear;
    }
    
    @keyframes float {
      0% { transform: translateY(100px) rotate(0deg); opacity: 0; }
      10% { opacity: 0.7; }
      90% { opacity: 0.7; }
      100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
    }
    
    .color-palette-selector {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 100;
      background: rgba(255,255,255,0.8);
      border-radius: 50px;
      padding: 10px 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
    }
    
    .palette-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .palette-btn.active {
      border-color: var(--primary);
      transform: scale(1.1);
    }
    
    .palette-btn:first-child {
      background: linear-gradient(45deg, #FFE5E5, #E5FFD6, #D6ECFF, #FFF9D6, #F0D6FF, #D6FFF0, #FFE5D6);
    }
    
    .palette-btn:nth-child(2) {
      background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fbc2eb, #a6c1ee, #c2e9fb, #d4fc79, #96fbc4);
    }
    
    .palette-btn:nth-child(3) {
      background: linear-gradient(45deg, #d9e7ff, #ffd9e7, #e7ffd9, #ffe7d9, #d9ffe7, #e7d9ff, #ffecd9);
    }
  </style>
</head>
<body>
  <div class="floating-leaves">
    <div class="leaf" style="left: 10%; animation-delay: 0s;">üçÉ</div>
    <div class="leaf" style="left: 30%; animation-delay: 3s;">üçÇ</div>
    <div class="leaf" style="left: 50%; animation-delay: 6s;">üå∏</div>
    <div class="leaf" style="left: 70%; animation-delay: 9s;">üçÅ</div>
    <div class="leaf" style="left: 90%; animation-delay: 12s;">üåø</div>
  </div>
  
  <div class="coloring-app">
    <div class="header">
      <button class="back-btn" onclick="window.history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      
      <div class="model-info">
        <div class="model-name">Coloring Meditation</div>
      </div>
      
      <button class="save-btn" id="download-btn">
        <i class="fas fa-save"></i>
      </button>
    </div>
    
    <div class="canvas-container">
      <canvas id="canvas"></canvas>
      <div class="animated-bg"></div>
      
      <button class="audio-control" id="audio-toggle">
        <i class="fas fa-music"></i>
      </button>
      
      <div class="color-palette-selector">
        <div class="palette-btn active" data-palette="pastel"></div>
        <div class="palette-btn" data-palette="vibrant"></div>
        <div class="palette-btn" data-palette="soft"></div>
      </div>
    </div>
    
    <div class="tools-panel">
      <button data-tool="fill" class="tool-btn active">
        <i class="fas fa-fill-drip"></i>
      </button>
      <button data-tool="brush" class="tool-btn">
        <i class="fas fa-paint-brush"></i>
      </button>
      <button data-tool="undo" class="tool-btn">
        <i class="fas fa-undo"></i>
      </button>
      <button data-tool="clear" class="tool-btn">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    
    <div class="colors-panel">
      <!-- Pastel Colors -->
      <div class="color-swatch active" data-color="#FFE5E5" style="background:#FFE5E5"></div>
      <div class="color-swatch" data-color="#E5FFD6" style="background:#E5FFD6"></div>
      <div class="color-swatch" data-color="#D6ECFF" style="background:#D6ECFF"></div>
      <div class="color-swatch" data-color="#FFF9D6" style="background:#FFF9D6"></div>
      <div class="color-swatch" data-color="#F0D6FF" style="background:#F0D6FF"></div>
      <div class="color-swatch" data-color="#D6FFF0" style="background:#D6FFF0"></div>
      <div class="color-swatch" data-color="#FFE5D6" style="background:#FFE5D6"></div>
      
      <div class="custom-color-wrapper">
        <div class="color-swatch" style="background:currentColor"></div>
        <input type="color" id="custom-color" value="#FFE5E5">
      </div>
    </div>
    
    <audio id="bg-music" loop></audio>
  </div>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  
  <script>
    // Color Palettes
    const palettes = {
      pastel: ["#FFE5E5", "#E5FFD6", "#D6ECFF", "#FFF9D6", "#F0D6FF", "#D6FFF0", "#FFE5D6"],
      vibrant: ["#FF9A9E", "#FAD0C4", "#FBC2EB", "#A6C1EE", "#C2E9FB", "#D4FC79", "#96FBC4"],
      soft: ["#D9E7FF", "#FFD9E7", "#E7FFD9", "#FFE7D9", "#D9FFE7", "#E7D9FF", "#FFECD9"]
    };
    
    // Initialize the canvas and context
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let tool = "fill";
    let color = "#FFE5E5";
    let history = [];
    let drawing = false;
    let dpr = window.devicePixelRatio || 1;
    
    // Set canvas size to match the container (with high DPI support)
    function setupCanvas() {
      const container = document.querySelector('.canvas-container');
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      // Set the canvas dimensions considering device pixel ratio
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      
      // Scale the context to ensure drawing operations use the correct size
      ctx.scale(dpr, dpr);
      
      // Set CSS dimensions to maintain the visible size
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      
      // Redraw the current image if available
      if (img) {
        drawImage();
      }
    }
    
    // Draw the line art image
    function drawImage() {
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Calculate aspect ratio and draw
      const hRatio = (canvas.width / dpr) / img.width;
      const vRatio = (canvas.height / dpr) / img.height;
      const ratio = Math.min(hRatio, vRatio);
      const centerX = (canvas.width / dpr - img.width * ratio) / 2;
      const centerY = (canvas.height / dpr - img.height * ratio) / 2;
      ctx.drawImage(img, centerX, centerY, img.width * ratio, img.height * ratio);
      
      // Save initial state for undo
      saveState();
    }
    
    // Load the image for coloring
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.src = "{{ image_url }}";
    img.onload = function() {
      setupCanvas();
      drawImage();
    };
    
    // Handle window resize
    window.addEventListener('resize', setupCanvas);
    
    // Flood fill function
    function floodFill(x, y) {
      // Get the image data
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const stack = [[x, y]];
      const startPos = (y * canvas.width + x) * 4;
      const targetColor = [data[startPos], data[startPos+1], data[startPos+2], data[startPos+3]];
      
      // Convert hex to RGB
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      const fillColor = [r, g, b, 255];
      
      // If target color is the same as fill color, return
      if (targetColor[0] === r && targetColor[1] === g && targetColor[2] === b) {
        return;
      }
      
      while (stack.length) {
        const [cx, cy] = stack.pop();
        const pos = (cy * canvas.width + cx) * 4;
        
        // Check boundaries
        if (cx < 0 || cx >= canvas.width || cy < 0 || cy >= canvas.height) {
          continue;
        }
        
        // Check if the current pixel matches the target color
        if (
          data[pos] === targetColor[0] &&
          data[pos+1] === targetColor[1] &&
          data[pos+2] === targetColor[2] &&
          data[pos+3] === targetColor[3]
        ) {
          // Fill the pixel
          data[pos] = fillColor[0];
          data[pos+1] = fillColor[1];
          data[pos+2] = fillColor[2];
          data[pos+3] = 255;
          
          // Add neighboring pixels
          stack.push([cx + 1, cy]);
          stack.push([cx - 1, cy]);
          stack.push([cx, cy + 1]);
          stack.push([cx, cy - 1]);
        }
      }
      
      ctx.putImageData(imageData, 0, 0);
      
      // Create a visual effect
      createFillEffect(x, y);
    }
    
    function saveState() {
      // Save current canvas state to history
      history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
      
      // Limit history size
      if (history.length > 20) {
        history.shift();
      }
    }
    
    function undoAction() {
      if (history.length > 1) {
        history.pop(); // Remove current state
        ctx.putImageData(history[history.length-1], 0, 0);
      } else if (history.length === 1) {
        ctx.putImageData(history[0], 0, 0);
      }
    }
    
    function createFillEffect(x, y) {
      const effect = document.createElement('div');
      effect.className = 'fill-effect';
      effect.style.left = `${x/dpr}px`;
      effect.style.top = `${y/dpr}px`;
      document.querySelector('.canvas-container').appendChild(effect);
      
      // Remove after animation
      setTimeout(() => {
        effect.remove();
      }, 500);
    }
    
    // Handle canvas events (coordinates adjusted for DPR)
    canvas.addEventListener('pointerdown', e => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * dpr;
      const y = (e.clientY - rect.top) * dpr;
      
      if (tool === "fill") {
        saveState();
        floodFill(Math.floor(x), Math.floor(y));
      } else if (tool === "brush") {
        saveState();
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.strokeStyle = color;
        ctx.lineWidth = 15 * dpr;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
      }
    });
    
    canvas.addEventListener('pointermove', e => {
      if (!drawing) return;
      
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * dpr;
      const y = (e.clientY - rect.top) * dpr;
      
      ctx.lineTo(x, y);
      ctx.stroke();
    });
    
    canvas.addEventListener('pointerup', () => {
      drawing = false;
      if (tool === "brush") {
        ctx.closePath();
      }
    });
    
    // Tool selection
    document.querySelectorAll('.tool-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        tool = this.dataset.tool;
        
        if (tool === 'undo') {
          undoAction();
        } else if (tool === 'clear') {
          if (confirm('Clear your artwork?')) {
            saveState();
            drawImage();
          }
        }
      });
    });
    
    // Color palette selection
    document.querySelectorAll('.palette-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.palette-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const paletteName = this.dataset.palette;
        const colors = palettes[paletteName];
        const colorSwatches = document.querySelectorAll('.colors-panel .color-swatch:not(.custom-color-wrapper)');
        
        colorSwatches.forEach((swatch, i) => {
          if (colors[i]) {
            swatch.style.backgroundColor = colors[i];
            swatch.dataset.color = colors[i];
          }
        });
        
        // Activate first color
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        colorSwatches[0].classList.add('active');
        color = colorSwatches[0].dataset.color;
        document.getElementById('custom-color').value = color;
      });
    });
    
    // Color selection
    document.querySelectorAll('.color-swatch:not(.custom-color-wrapper)').forEach(swatch => {
      swatch.addEventListener('click', function() {
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        this.classList.add('active');
        color = this.dataset.color;
        document.getElementById('custom-color').value = color;
      });
    });
    
    // Custom color
    const customColorInput = document.getElementById('custom-color');
    customColorInput.addEventListener('input', function() {
      color = this.value;
      // Activate the custom color swatch
      document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
      this.closest('.custom-color-wrapper').querySelector('.color-swatch').classList.add('active');
    });
    
    // Audio controls with Zen fade-in
    const audio = document.getElementById('bg-music');
    const audioToggle = document.getElementById('audio-toggle');
    
    // Get selected music from localStorage
    const selectedMusic = localStorage.getItem('selectedMusic') || '{{ music_files[0] }}';
    audio.src = "{{ url_for('static', filename='sounds/') }}" + selectedMusic;
    
    function fadeInAudio() {
      if (audio.paused) {
        audio.volume = 0;
        audio.play().catch(e => console.log('Audio play failed:', e));
        audioToggle.innerHTML = '<i class="fas fa-music"></i>';
        
        let fade = setInterval(() => {
          if (audio.volume < 0.5) {
            audio.volume = Math.min(audio.volume + 0.05, 0.5);
          } else {
            clearInterval(fade);
          }
        }, 100);
      }
    }
    
    // Start music on page load with fade-in
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(fadeInAudio, 1000);
    });
    
    audioToggle.addEventListener('click', function() {
      if (audio.paused) {
        fadeInAudio();
      } else {
        audio.pause();
        this.innerHTML = '<i class="fas fa-music-slash"></i>';
      }
    });
    
    // ZEN FEATURE: Auto-hide controls
    let ctrlTimeout;
    
    function showControls() {
      document.querySelectorAll('.tools-panel, .colors-panel').forEach(el => {
        el.style.opacity = 1;
        el.style.pointerEvents = 'all';
      });
      clearTimeout(ctrlTimeout);
      ctrlTimeout = setTimeout(hideControls, 3000);
    }
    
    function hideControls() {
      document.querySelectorAll('.tools-panel, .colors-panel').forEach(el => {
        el.style.opacity = 0;
        el.style.pointerEvents = 'none';
      });
    }
    
    // Show controls on any interaction
    canvas.addEventListener('pointermove', showControls);
    canvas.addEventListener('pointerdown', showControls);
    document.addEventListener('touchstart', showControls);
    
    // Initialize controls
    showControls();
    
    // Save artwork with Pi payment
    document.getElementById('download-btn').addEventListener('click', function() {
      // Initialize Pi SDK
      Pi.init({ version: "2.0" });
      
      Pi.authenticate(['username','payments']).then(auth => {
        const paymentData = {
          amount: 0.1, 
          memo: 'Download coloring art', 
          metadata: { 
            artwork: "Daily Coloring",
            timestamp: new Date().toISOString()
          }
        };
        
        const paymentCallbacks = {
          onReadyForServerApproval: (paymentId) => {
            console.log("Payment ready for approval:", paymentId);
          },
          onReadyForServerCompletion: (paymentId, txid) => { 
            console.log("Payment complete, txid:", txid);
            
            // Verify payment with our server
            fetch('/verify_payment', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ 
                txid: txid,
                amount: 0.1,
                artwork: "Daily Coloring"
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'verified') {
                // Trigger download
                const link = document.createElement('a');
                link.download = 'natsly-artwork.png';
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              } else {
                alert('Payment verification failed. Please contact support.');
              }
            })
            .catch(error => {
              console.error('Verification error:', error);
              alert('Error verifying payment. Please try again.');
            });
          },
          onCancel: (paymentId) => { 
            console.log("Payment cancelled:", paymentId);
            alert('Payment cancelled');
          },
          onError: (error, payment) => { 
            console.error("Payment error:", error);
            alert('Payment error: ' + error.message);
          }
        };
        
        Pi.createPayment(paymentData, paymentCallbacks);
      }).catch(error => {
        console.error('Pi authentication failed:', error);
        alert('Please authenticate with Pi first');
      });
    });
  </script>
</body>
</html>
